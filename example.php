<?
require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_before.php");

// Пример массива с артикулами товаров для выборки из базы данных
$arVendorCodes = array("100924","10962","100922","100921","10978","10977","11721","11734","100923","10125","10124","11598","11608","11606","10961","12296","11536","11735","10025","10034","10032","10031","10030","10041","10040","10039","10038","100920","10037","100219","12293","12497","10052","100691","10051","10050","10054","10062","10061","10015","10963","10964","10965","11733","11731","11729","100283","10465","11537","12295","12291","12292","100275","12233","11023","97851","97876","12522","101392","101390","101393","101394","100277","100278","100280","12531","12530","12529","12528","12527","12526","12525","12524","12523","12521","12520","12519","12518","12517","100297","100281","11680","11679","11043","11042","11041","12326","11681","100531","100734","11248","10620","10138","11600","10136","12262","100497","11153","11591","11584","10116","10678","10107","10111","10503","100733","100732","100731","100730","11783","11786","11785","11784","11255","11254","11249","100210","100209","100212","100213","101140","12418","10154","10153","12415","12414","11038","100496","100495","100537","100538","11033","11032","11031","12334","12333","12411","12332","12410","12409","12406","101136","100516","11065","10206","101425","11054","101168","101164","101165","100539","11558","11069","11004","101166","11657","11730","11245","11607","10140","11241","12294","97908","11073","10619","97682","100513","12395","12394","101137","101311","12393","12392","10135","10133","10128","10119","10114","10109","10110","12173","11776","100511","100969","101176","101174","101175","100856","12389","11296","10294","11050","100853","100854","100274","12501","11604","100503","100215","100284","100214","11003","10304","11301","11300","11298","10302","100211","10301","100272","100271","100270","10300","10299","10296","10295","100855","12624","12625","12435","12436","100729","12628","12629","12633","12437","12632","101127","101119","101118","101123","101124","101126","101125","10209","10165","10547","10514","100844","12309","11256","10996","10164","100850","100847","10166","10161","100208","10979","10181","12302","100514","12563","12562","12561","12516","12515","12514","10176","100528","10543","12171","11036","10546","10513","10189","10184","100843","100845","10993","10844","10833","11002","100266","10203","10984","10205","12319","100527","100526","100525","12513","10995","99502","99501","10832","10179","100851","100849","10840","10839","10838","10837","100265","12214","12652","12316","12310","12308","11025","10212","10202","10188","100519","12322","12169","12318","11162","11630","97835","97836","99497","101121","99498","100846","100301","97907","97877","97878","11605","10210","11214","10208","11212","10836","10835","11211","10207","10834","10366","10180","11213","10360","101286","10982","10841","10627","12510","100518","10831","10504","10539","10211","12653","100773","100776","12135","12137","100505","12470","12469","10999","10998","10997","100507","100506","10960","100510","100509","97842","97841","97840","12604","100727","12603","100522","12605","12478","12609","12607","12608","10415","10414","10413","101348","10279","11143","10278","11145","11144","101353","101352","101342","101341","101340","101351","12285","101350","11744","101347","11148","101339","97838","11737","11736","101349","10291","101338","12283","97839","101346","11147","12495","100302","12574","10463","100541","100542","100540","12575","10457","10456","10012","100536","100535","100303","11609","101389","101388","101387","101386","10017","97852","12192","12191","12232","100296","10275","10089","10090","11040","10078","10002","10155","12560","101411","10156","101161","101160","100502","11063","101159","100501","11076","10305","11052","11577","10313","101120","101128","12365","10267","101172","100827","101412","10001","100299","12368","100298","99500","100848","100300","10558","10550","10339","11062","10338","10359","100976","100975","100977","10397","10396","12564","100217","10399","97594","100774","100775","100777","101409","101408","12370","10764","12265","10272","12281","12282","10641","100268","100220","100267","10273","12264","10271","12287","10270","12263","12286","10269","12376","12617","12618","101343","101344","101345","12378","12380","12533","10496","97593","100512","101122","99496","12144","100498","10622","10195","11424","101085","12021","10373","101084","10365","100291","100292","100290","12535","10277","10280","10070","12217","12216","10499","10500","12261","11227","10501","11224","11226","11225","11055","11056","99562","99561","100799","100823","100822","100806","100821","100810","100809","100808","100807","100820","100797","100796","100795","100794","100805","100804","100798","100813","100812","100811","100824","100819","100803","100818","100802","100817","100801","100816","100800","100815","100814","100825","100826","101423","101422","101404","101401","10591","10592","10634","10633","10632","10636","10635","11304","10637","11215","12538","11021","11671","11775","10374","101424","100406","100415","100412","100411","100413","100410","100408","100378","100206","100377","100204","100350","100887","100884","100883","100787","100793","100792","100791","11305","100697","100698","100696","100695","100694","100486","100485","100872","100873","100693","100690","100688","100689","100687","99522","100334","10631","10638","101209","100701","100700","100332","100323","11770","97577","99513","11026","10985","10480","10986","10488","100326","100333","100327","100324","100198","100199","99527","99528","99526","100202","100200","100201","100372","99529","101399","100351","11661","99531","99530","100684","100305","10487","10483","100790","10495","10494","100876","10479","10987","100870","100869","10478","10988","10482","10969","10073","99504","11562","101400","100394","100403","10408","12499","10407","12237","12258","100493","99518","100376","99514","99519","99520","100358","100533","99516","99517","11660","101405","101415","100352","100362","100353","100375","100364","100365","100373","100347","100401","100393","100402","100398","100392","100359","100788","12536","12183","12184","11022","11631","100396","100404","100400","100397","11569","11567","100395","101134","101132","10152","10498","12532","100390","100370","100369","12539","100386","99508","99507","100384","99510","12540","99511","100387","99509","100383","99512","100207","12177","100786","11029","10474","10049","11672","10471","12544","12545","100917","101131","100750","100749","100552","101097","11237","100218","100546","100547","100548","100549","100544","100545","11247","11244","10371","10370","10375","100859","100858","100860","100857","100418","100417","99525","100205","100879","100878","100877","100719","100723","100722","100721","100720","100724","100717","100716","100718","100708","100707","100706","100705","100704","100715","100714","100713","100712","100711","100710","100421","100420","100419","100416","11638","11635","11633","12288","99524","99523","101410","100881","10589","10642","10644","10643","10639","11653","100919","11651","11641","11640","11639","101114","11780","11648","11645","11676","100868","11677","100941","100940","100942","100928","100939","100938","100937","100936","100935","100934","100929","100927","100933","100931","100932","100930","100926","97850","101096","101110","101108","101107","101106","10972","10971","100829","11602","100828","10970","11611","101333","101375","101355","101359","101358","101357","101356","101354","101337","100746","100385","97847","97848","97846","11156","101370","101369","101368","101367","101366","101365","101364","101371","101374","101373","101360","101363","101361","101377","100752","100753","100755","100754","100757","100761","100758","100751","101419","100328","100331","101323","101325","101317","101321","101318","101327","101316","101320","101322","101326","101314","101331","101332","101330","101335","101329","100867","99494","100863","100864","100862","100677","100675","100676","100672","100670","100668","12503","100674","101395","101418","100745","100744","101417","101376","101303","100865","100311","100915","100914","100913","100912","100911","11665","11667","12552","11221","11220","100840","11210","11655","100830","10974","10973","101416","18590","11686","100740","100770","100769","100861","100683","100388","12581","101402","100871","11302","100285","11668","14990","101135","100678","100682","100789","101101","11673","100748","100765","100766","101403","101413","101020","100992","101003","100918","101029","101023","100991","101014","101008","100984","101012","101031","100995","101001","101028","101016","101006","101009","101007","100988","101026","101017","101032","101004","100989","100990","101010","101000","101030","101025","101024","100993","101018","101015","101021","101002","101005","100986","100998","101022","100999","100994","100987","11573","11574","11572","11576","11575","12670","12327","100282","10105","100972","12136","100499","11788","11781","100517","12330","11030","11141","10394","10390","10065","11787","12498","12512","12553","11777","12611","12616","101098","101336","12613","12433","12534","101045","101068","101076","101228","101233","101221","101231","101253","101265","100956","101077","101071","100601","100599","100600","100598","101263","101267","100964","100957","101066","101065","101046","100958","101074","101248","101049","101047","101048","101072","100949","101234","101224","101282","101281","101277","101252","101262","101238","101264","101241","101259","101261","101244","101260","101251","101230","101250","101245","101236","101255","101246","101247","101269","101272","101239","101235","101242","101215","101217","101218","101219","101220","101223","101227","101229","101254","101249","101258","101280","101273","101237","101216","101240","101271","101214","101266","101268","101275","100646","101070","101044","100962","101078","101222","101061","101058","101060","101067","101053","101052","101054","100624","100622","100618","100623","100620","100619","100621","100961","100617","100614","100616","100615","100954","100609","100557","100612","100576","100610","100554","100558","100559","100573","100611","100613","100574","100575","101050","100960","100959","101059","101057","100951","100953","100950","100947","100955","100952","100945","100655","100651","100654","100650","100660","100638","100642","100641","100647","100639","100648","100656","100658","100659","100635","100636","100645","100649","100653","100637","100652","100644","100643","100657","101042","101051","100963","101069","100960","100894","100896","100895","100905","100907","100906","101064");

// Подключение модуля инфоблоки
// Документация: http://dev.1c-bitrix.ru/api_help/iblock/index.php
CModule::IncludeModule("iblock");

// Подкючение справчников
CModule::IncludeModule("highloadblock");
use Bitrix\Highloadblock as HL;

// Массив всех разделов каталога товаров (на случай, если понадобится)
$arSections = GetAllSections();
// Массив всех брендов из справочника
$arBrands = GetAllBrands();

// Получение списка элементов (товаров)
// Документация: http://dev.1c-bitrix.ru/api_help/iblock/classes/ciblockelement/getlist.php
$rsElements = CIBlockElement::GetList(
	// SORT: Сортировка по идентификатору
	array(
		"ID" => "ASC"
	),
	// FILTER: Фильтр по инфоблоку каталога товаров (8) и массиву с артикулами
	array(
		"IBLOCK_ID" => 8,
		"PROPERTY_VENDOR_CODE" => $arVendorCodes
	),
	false,
	false,
	// SELECT: Выборка полей
	array(
		"ID",                     // идентификатор товара
		"IBLOCK_ID",              // инфоблок елемента
		"NAME",                   // название товара
		"IBLOCK_SECTION_ID",      // идентификатор раздела для товара
		"PROPERTY_VENDOR_CODE",   // свойство: артикул
		"PROPERTY_CATEGORY_TYPE", // свойство: тип категории
		"PROPERTY_BRAND",         // свойство: бренд (выбирается идентификатор для справочника)
		"PROPERTY_MODEL",         // свойство: модель
		"PROPERTY_MODEL_NAME",    // свойство: модель
		"PROPERTY_SHORT_NAME",    // свойство: короткое название
	)
);

// Выборка значений полей в массив
// Документация: https://dev.1c-bitrix.ru/api_help/main/reference/cdbresult/fetch.php
$arElements = array();
while ($arElement = $rsElements->Fetch())
{
	// Подготваливаем удобный массив для вывода
	$arElements[] = array(
		"ID" => $arElement["ID"],
		"NAME" => $arElement["NAME"],
		"SUB_SECTION" => GetElementSubSection($arElement["IBLOCK_SECTION_ID"], $arSections), // получение раздела вторго уровня текущего элемента
		"PROPERTIES" => array(
			"VENDOR_CODE" => $arElement["PROPERTY_VENDOR_CODE_VALUE"],
			"CATEGORY_TYPE" => $arElement["PROPERTY_CATEGORY_TYPE_VALUE"],
			"BRAND" => GetBrand($arElement["PROPERTY_BRAND_VALUE"], $arBrands), // получение названия бренда
			"MODEL" => $arElement["PROPERTY_MODEL_VALUE"],
			"MODEL_NAME" => $arElement["PROPERTY_MODEL_NAME_VALUE"],
			"SHORT_NAME" => $arElement["PROPERTY_SHORT_NAME_VALUE"]
		)
	);
}

// Вывдоим данные в браузер
echo "<pre>";
print_r($arElements);
echo "</pre>";

// Обновление свойств у товара
// Документация: http://dev.1c-bitrix.ru/api_help/iblock/classes/ciblockelement/setpropertyvaluesex.php

// Идентификатор товара из выборки выше по артикулу 100856
$idElement = 460;

$arFields = array(
	"CATEGORY_TYPE" => "Швейная машина",
	"MODEL" => "000001",
	"MODEL_NAME" => "TEST",
	"SHORT_NAME" => "TS"
);
//CIBlockElement::SetPropertyValuesEx($idElement, 8, $arFields);

//------------------------
// Вспомогательные функции
//------------------------

// Получение списка всех разделов из каталога товаров
function GetAllSections()
{
	$rsSections = CIBlockSection::GetList(
		array("LEFT_MARGIN" => "ASC"),
		array(
			"IBLOCK_ID" => 8
		)
	);

	$arSections = array();
	while($arSection = $rsSections->Fetch())
	{
		$arSections[$arSection["ID"]] = $arSection;
	}

	return $arSections;
}

// Выборка из массива раздела второго уровня
function GetElementSubSection($idSection, $arSections)
{
	$arSection = $arSections[$idSection];

	if ($arSection["DEPTH_LEVEL"] > 2)
	{
		$arSection = GetElementSubSection($arSection["IBLOCK_SECTION_ID"], $arSections);
	}

	$arResult = array(
		"ID" => $arSection["ID"],
		"NAME" => $arSection["NAME"]
	);

	return $arResult;
}

// Получение списка всех брендов из справочника (id 1)
function GetAllBrands()
{
	$arBlock = HL\HighloadBlockTable::getById(1)->fetch();
	$rsEntity = HL\HighloadBlockTable::compileEntity($arBlock);

	$rsEntityDataClass = $rsEntity->getDataClass();
	$eTableName = $arBlock["TABLE_NAME"];

	$idTable = 'tbl_'.$eTableName;
	$rsBrands = $rsEntityDataClass::getList(array(
		"select" => array(
			"ID",
			"UF_NAME",
			"UF_XML_ID"
		),
		"filter" => array(),
		"order" => array(
			"ID" => "ASC"
		)
	));

	$arBrands = array();
	$rsBrands = new CDBResult($rsBrands, $idTable);
	while ($arBrand = $rsBrands->Fetch())
	{
		$arBrands[$arBrand["UF_XML_ID"]] = array(
			"ID" => $arBrand["ID"],
			"UF_XML_ID" => $arBrand["UF_XML_ID"],
			"NAME" => $arBrand["UF_NAME"]
		);
	}

	return $arBrands;
}

// Выборка из массива бренда по UF_XML_ID
function GetBrand($idBrand, $arBrands)
{
	return $arBrands[$idBrand];
}

function curlGet($url, $arHeaders, $return_header_in_result = false)
{
    $handle = curl_init();
    curl_setopt($handle, CURLOPT_URL, $url);
    curl_setopt($handle, CURLOPT_RETURNTRANSFER, true);
    if (!empty($arHeaders))
        curl_setopt($handle, CURLOPT_HTTPHEADER, $arHeaders);
    if ($return_header_in_result)
        curl_setopt($handle, CURLOPT_HEADER, 1);
    curl_setopt($handle, CURLOPT_SSL_VERIFYHOST, false);
    curl_setopt($handle, CURLOPT_SSL_VERIFYPEER, false);
    $response = curl_exec($handle);
    $code = curl_getinfo($handle, CURLINFO_HTTP_CODE);
    return array("code" => $code, "response" => $response);
}