(function(){BX.namespace("BX.Sender.Letter");if(BX.Sender.Letter.Time){return}var e=BX.Sender.Page;var t=BX.Sender.Helper;function i(){this.context=null}i.prototype.init=function(i){this.context=BX(i.containerId);this.actionUri=i.actionUri;this.isFrame=i.isFrame||false;this.isSaved=i.isSaved||false;this.isSupportReiterate=i.isSupportReiterate||false;this.prettyDateFormat=i.prettyDateFormat;this.mess=i.mess||{atTime:"",defered:""};this.selectorNode=t.getNode("time-selector",this.context);this.inputNode=t.getNode("time-input",this.context);BX.bind(this.selectorNode,"click",this.showMenu.bind(this));if(this.isFrame&&this.isSaved){BX.Sender.Page.slider.close()}this.scheduleNodes={daysOfWeek:t.getNode("time-reiterate-days-of-week",this.context),timesOfDay:t.getNode("time-reiterate-times-of-day",this.context)};this.schedule=new s({caller:this,context:t.getNode("time-reiterate",this.context)});var o=this.inputNode.value;var n=BX.parseDate(this.inputNode.value);if(o&&n){this.setFormattedDate(n)}else if(this.scheduleNodes.timesOfDay.value){this.schedule.setText()}else{this.selectorNode.textContent=this.mess.defered}e.initButtons()};i.prototype.onPopupClose=function(){};i.prototype.onClick=function(e){this.popupMenu.close();if(e==="time"){this.showCalendar(this.selectorNode);return}if(e==="schedule"){this.schedule.show();return}var t=null;var i=this.popupMenu.getMenuItem(e);if(!i){return}else if(e==="defered"){t=null}else if(e==="now"){t="now"}this.selectorNode.textContent=i.text;this.inputNode.value=t};i.prototype.onTimeSet=function(e){if(!e){return}var t=new Date;if(e<t){e=t}this.setFormattedDate(e);this.inputNode.value=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")),e)};i.prototype.setFormattedDate=function(e){var t=BX.isAmPmMode();var i=this.prettyDateFormat+" ";i+=this.mess.atTime;i+=" "+(t?"g:i a":"H:i");this.selectorNode.textContent=BX.date.format(i,e)};i.prototype.onPopupItemEnter=function(e){var t=this.popupMenu.getMenuItem(e);if(!t){return}if(e==="time"){}else{BX.calendar.get().Close()}};i.prototype.showCalendar=function(e){var t=this.inputNode.value;if(t){t=BX.parseDate(t,true)}BX.calendar({node:e,value:t,bTime:true,bHideTime:false,callback:function(){return true},callback_after:this.onTimeSet.bind(this)})};i.prototype.showMenu=function(){if(this.popupMenu){this.popupMenu.show();return}var e=[{id:"now",text:this.mess.now},{id:"defered",text:this.mess.defered},{id:"time",text:this.mess.time}];if(this.isSupportReiterate){e.push({id:"schedule",text:this.mess.schedule})}e.forEach(function(e){e.onclick=this.onClick.bind(this,e.id);e.events={onMouseEnter:this.onPopupItemEnter.bind(this,e.id)}},this);this.popupMenu=BX.PopupMenu.create("sender-letter-time",this.selectorNode,e,{autoHide:true,offsetLeft:40,angle:{position:"top",offset:42},events:{onPopupClose:this.onPopupClose.bind(this)}});this.popupMenu.show()};function s(e){this.init(e)}s.prototype={popup:null,activeClassName:"sender-letter-time-popup-date-item-current",init:function(e){this.caller=e.caller;this.context=e.context;this.timesOfDayNode=t.getNode("reiterate-times-of-day",this.context);if(this.caller.scheduleNodes.timesOfDay.value){this.timesOfDayNode.value=this.caller.scheduleNodes.timesOfDay.value}this.daysOfWeekNodes=t.getNodes("reiterate-days-of-week",this.context);var i=this.caller.scheduleNodes.daysOfWeek.value;this.daysOfWeekNodes.forEach(function(e){BX.bind(e,"click",this.selectWeekDay.bind(this,e));if(i){var s=i.indexOf(e.getAttribute("data-value"))>=0;t.changeClass(e,this.activeClassName,s)}},this)},show:function(){if(!this.popup){this.popup=BX.PopupWindowManager.create("sender-letter-time-schedule",this.caller.selectorNode,{content:this.context,autoHide:true,lightShadow:false,width:250,closeByEsc:true,contentColor:"white",angle:true,buttons:[new BX.PopupWindowButton({text:this.caller.mess.accept,className:"popup-window-button-accept",events:{click:this.onApply.bind(this)}})]})}if(this.popup.isShown()){return}this.popup.show()},selectWeekDay:function(e){var t=e.getAttribute("data-value");if(!t){return}BX.toggleClass(e,this.activeClassName)},setText:function(){var e=this.getWeekDayNodes().map(function(e){return e.textContent.trim()}).join(", ");var t=this.getTime();var i=this.caller.mess.scheduleText;i=i.replace("%time%",t);i=i.replace("%days%",e);this.caller.selectorNode.textContent=i},getTime:function(){return this.timesOfDayNode.value},getWeekDayNodes:function(){return this.daysOfWeekNodes.filter(function(e){return BX.hasClass(e,this.activeClassName)},this)},onApply:function(){this.caller.scheduleNodes.daysOfWeek.value=this.getWeekDayNodes().map(function(e){return e.getAttribute("data-value")}).join(",");this.caller.scheduleNodes.timesOfDay.value=this.getTime();this.caller.inputNode.value="schedule";this.setText();this.popup.close()}};BX.Sender.Letter.Time=new i})(window);